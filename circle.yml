machine:
  node:
    version: 4

dependencies:
  pre:
    - git clone --depth 1 https://github.com/mozilla/fxa-js-client
    - cd fxa-js-client && npm run setup

    - git clone --depth 1 https://github.com/mozilla/fxa-content-server
    - cp fxa-content-server/server/config/local.json-dist fxa-content-server/server/config/local.json
    - cd fxa-content-server && npm i --production
    - cd fxa-content-server && CONFIG_FILES=server/config/local.json,server/config/production.json node_modules/.bin/grunt build
    - cd fxa-content-server && npm i intern@3.4.2 bower zaach/node-XMLHttpRequest.git#onerror firefox-profile@0.3.12 request@2.74.0 sync-exec@0.6.2 convict@1.4.0

    - git clone --depth 1 https://github.com/mozilla/fxa-oauth-server
    - cd fxa-oauth-server && npm i --production

    - git clone --depth 1 https://github.com/mozilla/fxa-profile-server
    - sudo apt-get install graphicsmagick
    - cd fxa-profile-server && npm i --production

    - git clone --depth 1 --branch http https://github.com/vladikoff/browserid-verifier
    - cd browserid-verifier && npm i --production

    - pip install mozdownload mozinstall
    - mozdownload --version 50.1.0 --destination firefox.tar.bz2
    - mozinstall firefox.tar.bz2

    - ulimit -S -n 2048

    - sudo apt-get install expect tightvncserver
    - mkdir -p $HOME/.vnc
    - bash fxa-content-server/tests/ci/setvncpass.sh
    - tightvncserver :1
    - export DISPLAY=:1

    - npm i -g retry-cli

  override:
    - npm i

  post:
    - SIGNIN_UNBLOCK_ALLOWED_EMAILS="^block.*@restmail\\.net$" SIGNIN_UNBLOCK_FORCED_EMAILS="^block.*@restmail\\.net$" npm start 2>&1 | tee $HOME/fxa-auth-server.log:
        background: true

    - cd fxa-content-server && CONFIG_FILES=server/config/local.json,server/config/production.json node_modules/.bin/grunt serverproc:dist 2>&1 | tee $HOME/fxa-content-server.log:
        background: true

    - cd fxa-oauth-server && LOG_LEVEL=error NODE_ENV=dev node ./bin/server 2>&1 | tee $HOME/fxa-oauth-server.log:
        background: true

    - cd fxa-profile-server && LOG_LEVEL=error NODE_ENV=dev npm start 2>&1 | tee $HOME/fxa-profile-server.log:
        background: true

    - cd browserid-verifier && PORT=5050 CONFIG_FILES=../fxa-content-server/tests/ci/config_verifier.json node server 2>&1 | tee $HOME/browserid-verifier.log:
        background: true

    - curl 127.0.0.1:3030/ver.json
    - firefox/firefox --version

test:
  override:
    - cd fxa-js-client && npm run test-local

    - cd fxa-content-server && retry -n 1 -- node_modules/.bin/intern-runner config=tests/intern_functional_circle firefoxBinary=$HOME/fxa-auth-server/firefox/firefox fxaProduction=true fxaAuthRoot=http://127.0.0.1:9000/v1 fxaEmailRoot=http://127.0.0.1:9001 fxaOauthApp=http://127.0.0.1:8080:
        parallel: true

